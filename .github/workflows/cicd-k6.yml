---

name: CI/CD

on:
  push:
    branches: [demo]
  pull_request:
    branches: [demo]
  workflow_call:
    inputs:
      systemUnderTest:
        description: 'System Under Test'
        required: false
        default: 'BumbleBee'
        type: string
#        options:
#          - BumbleBee
#          - JetFire
      workload:
        description: 'Workload'
        required: false
        default: 'load'
        type: string
#        options:
#          - load
#          - stress
      service:
        description: 'Service name'
        required: false
        default: 'bumble-bee'
        type: string
#        options:
#          - bumble-bee
#          - optimus-prime
#          - jet-fire
      runner:
        description: 'Runner environment'
        default: 'acme'
        required: false
        type: string
#        options:
#          - acme
#          - test

jobs:

  build:
    uses: perfana/afterburner/.github/workflows/build-deploy.yml@main
    secrets: inherit

  prepare-performance-test:
    uses: perfana/afterburner/.github/workflows/prepare-performance-test.yml@main
    needs: build
    secrets: inherit
    with:
      service: ${{ inputs.service }}

  performance-test-k6:
    uses: perfana/afterburner/.github/workflows/run-k6-test.yml@main
    needs: prepare-performance-test
    secrets: inherit
    with:
      systemUnderTest: ${{ inputs.systemUnderTest }}
      workload: ${{ inputs.workload }}
      service: ${{ inputs.service }}
      runner: ${{ inputs.runner }}
